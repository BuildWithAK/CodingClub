<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coding Club Dashboard</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Lottie -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.10.1/lottie.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
.card { background:white; border-radius:12px; padding:1rem; box-shadow:0 6px 20px rgba(0,0,0,0.05); }
#profileInitials { background-size: cover; background-position: center; }
.progress-bar { background: #E5E7EB; border-radius: 12px; overflow: hidden; height: 16px; }
.progress-bar .progress { background: #34D399; height: 100%; width: 0%; transition: width 0.3s; }
.task-item.completed { background: #DCFCE7; padding: 0.5rem; border-radius: 0.5rem; }
.task-item.in-progress { background: #FEF3C7; padding: 0.5rem; border-radius: 0.5rem; }
</style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

<header class="bg-green-500 text-white p-4 flex justify-between items-center">
  <h1 class="text-xl font-bold">Coding Club Dashboard</h1>
  <button id="logoutBtn" class="bg-white text-green-500 px-4 py-2 rounded">Logout</button>
</header>

<main class="flex-1 max-w-7xl mx-auto p-4 grid grid-cols-1 md:grid-cols-3 gap-6">

  <!-- Left Panel -->
  <section class="md:col-span-2 space-y-6">

    <!-- Profile -->
    <div class="card flex items-center gap-6 p-6 relative">
      <div class="w-24 h-24 rounded-full bg-gray-300 flex items-center justify-center text-3xl font-bold text-white cursor-pointer" id="profileInitials">AK</div>
      <input type="file" id="profileUpload" accept="image/png, image/jpeg" class="hidden">
      <div class="flex-1">
        <h2 id="fullname" class="text-2xl font-semibold">Name</h2>
        <p id="email" class="text-gray-500">abc@example.com</p>
        <p id="college" class="text-gray-500">college name</p>
        <p id="memberSince">Member since: —</p>
      </div>
    </div>

    <!-- Weekly Progress Chart -->
    <div class="card p-4 space-y-4">
      <h3 class="font-semibold text-lg">Weekly Progress</h3>
      <canvas id="weeklyChart" height="120"></canvas>
    </div>

    <!-- Courses -->
    <div class="card p-4 space-y-4">
      <h3 class="font-semibold text-lg">Courses</h3>
      <div id="coursesList" class="space-y-2"></div>
      <div class="flex gap-2 mt-2">
        <input id="newCourseName" type="text" placeholder="New Course Name" class="flex-1 border rounded px-2 py-1">
        <button id="addCourseBtn" class="bg-green-500 text-white px-4 py-1 rounded">Add</button>
      </div>
    </div>

    <!-- Achievements & Certifications -->
    <div class="card p-4 space-y-4">
      <h3 class="font-semibold text-lg">Achievements & Certifications</h3>
      <div id="achievementsList"></div>
      <div class="flex gap-2">
        <input id="newAchievement" type="text" placeholder="Add achievement" class="flex-1 border rounded px-2 py-1">
        <button id="addAchievementBtn" class="bg-blue-500 text-white px-4 py-1 rounded">Add</button>
      </div>
      <hr>
      <div id="certsList"></div>
      <div class="flex gap-2">
        <input id="newCert" type="text" placeholder="Add certification" class="flex-1 border rounded px-2 py-1">
        <button id="addCertBtn" class="bg-blue-500 text-white px-4 py-1 rounded">Add</button>
      </div>
    </div>

    <!-- Overall Progress -->
    <div class="card p-4">
      <h3 class="font-semibold text-lg">Overall Progress</h3>
      <div class="progress-bar">
        <div id="overallProgress" class="progress"></div>
      </div>
      <span id="overallProgressText" class="text-sm text-gray-600">0%</span>
    </div>

    <!-- Average Test Score -->
    <div class="card p-4">
      <h3 class="font-semibold text-lg">Average Test Score</h3>
      <span id="avgTestScore" class="text-2xl font-bold">0</span>/100
    </div>

    <!-- Recent Tasks -->
    <div class="card p-4">
      <h3 class="font-semibold text-lg">Recent Tasks</h3>
      <div id="recentTasks" class="space-y-1"></div>
    </div>

    <!-- Test Results -->
    <div class="card p-4">
      <h3 class="font-semibold text-lg">Test Results</h3>
      <div id="testResults" class="space-y-2"></div>
    </div>

  </section>

  <!-- Right Panel -->
  <aside class="space-y-6">

    <!-- Leaderboard -->
    <div class="card p-4">
      <h3 class="font-semibold text-lg mb-2">Leaderboard (Weekly)</h3>
      <div id="leaderboardList" class="space-y-2 max-h-64 overflow-y-auto"></div>
    </div>

  </aside>

</main>

<footer class="bg-gray-800 text-white p-4 text-center">© 2025 Coding Club</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, doc, onSnapshot, updateDoc, arrayUnion, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAn5x2mrHMe9tVAEGDL7XbQoL6RG-xbUfw",
  authDomain: "codingclub-website.firebaseapp.com",
  projectId: "codingclub-website",
  storageBucket: "codingclub-website.appspot.com",
  messagingSenderId: "349607815709",
  appId: "1:349607815709:web:edbdfe68f217fba585f4f4",
  measurementId: "G-5NDXD3NWK2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// DOM Elements
const logoutBtn = document.getElementById('logoutBtn');
const profileInitials = document.getElementById('profileInitials');
const profileUpload = document.getElementById('profileUpload');
const fullnameEl = document.getElementById('fullname');
const emailEl = document.getElementById('email');
const college = document.getElementById('college');
const memberSinceEl = document.getElementById('memberSince');
const weeklyChartCtx = document.getElementById('weeklyChart').getContext('2d');
const leaderboardList = document.getElementById('leaderboardList');
const coursesList = document.getElementById('coursesList');
const newCourseName = document.getElementById('newCourseName');
const addCourseBtn = document.getElementById('addCourseBtn');
const achievementsList = document.getElementById('achievementsList');
const newAchievement = document.getElementById('newAchievement');
const addAchievementBtn = document.getElementById('addAchievementBtn');
const certsList = document.getElementById('certsList');
const newCert = document.getElementById('newCert');
const addCertBtn = document.getElementById('addCertBtn');

let currentUserUid = null;
let currentUserRole = 'user';
let weeklyChart = null;

// Helper function: initials
function getInitials(name){
  if(!name) return 'U';
  return name.split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase();
}

// Logout
logoutBtn.onclick = ()=> signOut(auth).then(()=>window.location.href='login.html');

// Auth state
onAuthStateChanged(auth, async user => {
  if(!user) return window.location.href='login.html';
  currentUserUid = user.uid;
  const userDocRef = doc(db,'users',currentUserUid);

  // SINGLE SNAPSHOT for all user data
  onSnapshot(userDocRef, snapshot => {
    const data = snapshot.data();
    if(!data) return;

    // Profile
    fullnameEl.textContent = data.fullname || 'User';
    emailEl.textContent = data.email || 'abc@example.com';
    college.textContent = data.college || 'College';
   /* memberSinceEl.textContent = `Member since: ${data.createdAt ? new Date(data.createdAt.seconds*1000).toLocaleDateString() : '—'}`;
    profileInitials.textContent = getInitials(data.fullname);
    */
    let memberSince = '—';

if (data.createdAt) {
    if (data.createdAt.seconds !== undefined) {
        // Firestore Timestamp object
        memberSince = new Date(data.createdAt.seconds * 1000).toLocaleDateString();
    } else {
        // Already Date or ISO string
        memberSince = new Date(data.createdAt).toLocaleDateString();
    }
}

memberSinceEl.textContent = `Member since: ${memberSince}`;


    if(data.profilePicURL){
      profileInitials.style.backgroundImage = `url(${data.profilePicURL})`;
      profileInitials.textContent = '';
    }

    // Role
    currentUserRole = data.role || 'user';

    // Weekly Chart
    renderWeeklyProgressChart(data.weeklyScores || {});

    // Courses / Achievements / Certifications
    renderCourses(data.courses || []);
    renderAchievements(data.achievements || []);
    renderCerts(data.certifications || []);

    // Dashboard stats
    const totalTasks = data.tasks?.length || 0;
    const completedTasks = data.tasks?.filter(t=>t.status==='completed').length || 0;
    const progressPercent = totalTasks ? Math.round((completedTasks/totalTasks)*100) : 0;
    document.getElementById('overallProgress').style.width = progressPercent + '%';
    document.getElementById('overallProgressText').textContent = progressPercent + '%';

    const avgScore = data.tests?.length
      ? Math.round(data.tests.reduce((sum,t)=>sum+t.score,0)/data.tests.reduce((sum,t)=>sum+t.total,0)*100)
      : 0;
    document.getElementById('avgTestScore').textContent = avgScore;

    // Recent tasks
    const recentTasksEl = document.getElementById('recentTasks');
    recentTasksEl.innerHTML = '';
    (data.tasks || []).slice(-5).reverse().forEach(task=>{
      const div = document.createElement('div');
      div.className = `task-item ${task.status==='completed'?'completed':'in-progress'}`;
      div.innerHTML = `<span>${task.name}</span> - <strong>${task.status}</strong>`;
      recentTasksEl.appendChild(div);
    });

    // Leaderboard
    const usersCol = collection(db,'users');
    leaderboardList.innerHTML = '';
    const q = query(usersCol, orderBy('createdAt','desc'));
    onSnapshot(q, snap=>{
      const users = [];
      snap.forEach(docSnap=>{
        const u = docSnap.data();
        let total = 0;
        if(u.weeklyScores){
          const today = new Date();
          const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
          const key = startOfWeek.toISOString().split('T')[0];
          total = u.weeklyScores[key] || 0;
        }
        users.push({name:u.fullname||'—', score:total});
      });
      users.sort((a,b)=>b.score - a.score);
      leaderboardList.innerHTML = '';
      users.forEach((u,i)=>{
        const div = document.createElement('div');
        div.className = 'flex justify-between p-2 bg-gray-100 rounded';
        div.innerHTML = `<span>${i+1}. ${u.name}</span> <span>${u.score}</span>`;
        leaderboardList.appendChild(div);
      });
    });
  });
});

// Profile picture upload
profileInitials.onclick = ()=> profileUpload.click();
profileUpload.onchange = async e => {
  const file = e.target.files[0];
  if(!file) return;
  const storageRef = ref(storage, `profilePics/${currentUserUid}`);
  const uploadTask = uploadBytesResumable(storageRef, file);
  uploadTask.on('state_changed', null, null, async ()=>{
    const url = await getDownloadURL(uploadTask.snapshot.ref);
    await updateDoc(doc(db,'users',currentUserUid), { profilePicURL:url });
  });
};

// Weekly progress chart
function renderWeeklyProgressChart(weeklyScores){
  const today = new Date();
  const days=[], scores=[];
  for(let i=6;i>=0;i--){
    const d = new Date();
    d.setDate(today.getDate()-i);
    const key = d.toISOString().split('T')[0];
    days.push(key);
    scores.push(weeklyScores[key]||0);
  }

  if(weeklyChart){
    weeklyChart.data.labels = days.map(d=>d.slice(5));
    weeklyChart.data.datasets[0].data = scores;
    weeklyChart.update();
    return;
  }

  weeklyChart = new Chart(weeklyChartCtx, {
    type:'bar',
    data:{labels:days.map(d=>d.slice(5)), datasets:[{label:'Daily Score', data:scores, backgroundColor:'#34D399'}]},
    options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true, stepSize:5}}}
  });
}

// Render Courses / Achievements / Certifications
function renderCourses(courses){
  coursesList.innerHTML = '';
  courses.forEach(c=>{
    const div = document.createElement('div');
    div.className = 'p-2 bg-gray-100 rounded';
    div.textContent = c;
    coursesList.appendChild(div);
  });
}
addCourseBtn.onclick = async ()=>{
  const name = newCourseName.value.trim();
  if(!name) return;
  await updateDoc(doc(db,'users',currentUserUid), { courses: arrayUnion(name) });
  newCourseName.value='';
};

function renderAchievements(achievements){
  achievementsList.innerHTML = '';
  achievements.forEach(a=>{
    const div = document.createElement('div');
    div.className = 'p-2 bg-gray-100 rounded';
    div.textContent = a;
    achievementsList.appendChild(div);
  });
}
addAchievementBtn.onclick = async ()=>{
  const text = newAchievement.value.trim();
  if(!text) return;
  await updateDoc(doc(db,'users',currentUserUid), { achievements: arrayUnion(text) });
  newAchievement.value='';
};

function renderCerts(certs){
  certsList.innerHTML = '';
  certs.forEach(c=>{
    const div = document.createElement('div');
    div.className = 'p-2 bg-gray-100 rounded';
    div.textContent = c;
    certsList.appendChild(div);
  });
}
addCertBtn.onclick = async ()=>{
  const text = newCert.value.trim();
  if(!text) return;
  await updateDoc(doc(db,'users',currentUserUid), { certifications: arrayUnion(text) });
  newCert.value='';
};

</script>

</body>
</html>
