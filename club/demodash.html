<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coding Club Dashboard</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
.card { background:white; border-radius:12px; padding:1rem; box-shadow:0 6px 20px rgba(0,0,0,0.05); }
.task-item { display:flex; justify-content:space-between; padding:0.5rem; border-radius:6px; }
.test-item { padding:0.5rem; border-radius:6px; background:#f3f3f3; margin-bottom:0.5rem; }
</style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

<header class="bg-green-500 text-white p-4 flex justify-between items-center">
  <h1 class="text-xl font-bold">Coding Club Dashboard</h1>
  <button id="logoutBtn" class="bg-white text-green-500 px-4 py-2 rounded">Logout</button>
</header>

<main class="flex-1 max-w-7xl mx-auto p-4 grid grid-cols-1 md:grid-cols-3 gap-6">

  <!-- Left Panel -->
  <section class="md:col-span-2 space-y-6">

    <!-- Profile -->
    <div class="card flex items-center gap-6 p-6 relative">
      <div id="profileInitials" class="w-24 h-24 rounded-full bg-gray-300 flex items-center justify-center text-3xl font-bold text-white cursor-pointer">AK</div>
      <input type="file" id="profileUpload" accept="image/png, image/jpeg" class="hidden">
      <div class="flex-1">
        <h2 id="fullname" class="text-2xl font-semibold">Name</h2>
        <p id="email" class="text-gray-500">abc@example.com</p>
        <p id="college" class="text-gray-500">College Name</p>
        <p id="memberSince">Member since: —</p>
      </div>
    </div>

    <!-- Weekly Progress Chart -->
    <div class="card p-4">
      <h3 class="font-semibold text-lg">Weekly Progress</h3>
      <canvas id="weeklyChart" height="120"></canvas>
    </div>

    <!-- Courses -->
    <div class="card p-4 space-y-4">
      <h3 class="font-semibold text-lg">Courses</h3>
      <div id="coursesList" class="space-y-2"></div>
      <div class="flex gap-2 mt-2">
        <input id="newCourseName" type="text" placeholder="New Course Name" class="flex-1 border rounded px-2 py-1">
        <button id="addCourseBtn" class="bg-green-500 text-white px-4 py-1 rounded">Add</button>
      </div>
    </div>

    <!-- Achievements & Certifications -->
    <div class="card p-4 space-y-4">
      <h3 class="font-semibold text-lg">Achievements & Certifications</h3>
      <div id="achievementsList"></div>
      <div class="flex gap-2">
        <input id="newAchievement" type="text" placeholder="Add achievement" class="flex-1 border rounded px-2 py-1">
        <button id="addAchievementBtn" class="bg-blue-500 text-white px-4 py-1 rounded">Add</button>
      </div>
      <hr>
      <div id="certsList"></div>
      <div class="flex gap-2">
        <input id="newCert" type="text" placeholder="Add certification" class="flex-1 border rounded px-2 py-1">
        <button id="addCertBtn" class="bg-blue-500 text-white px-4 py-1 rounded">Add</button>
      </div>
    </div>

    <!-- Dashboard Stats -->
    <div class="card p-4 space-y-4">
      <h3 class="font-semibold text-lg">Overall Progress</h3>
      <div class="w-full bg-gray-200 h-4 rounded">
        <div id="overallProgress" class="bg-green-500 h-4 rounded w-0"></div>
      </div>
      <span id="overallProgressText" class="text-sm text-gray-600">0%</span>
    </div>

    <div class="card p-4">
      <h3 class="font-semibold text-lg">Average Test Score</h3>
      <span id="avgTestScore" class="text-2xl font-bold">0</span>/100
    </div>

    <div class="card p-4">
      <h3 class="font-semibold text-lg">Recent Tasks</h3>
      <div id="recentTasks" class="space-y-1"></div>
    </div>

    <div class="card p-4">
      <h3 class="font-semibold text-lg">Test Results</h3>
      <div id="testResults" class="space-y-2"></div>
    </div>

  </section>

  <!-- Right Panel -->
  <aside class="space-y-6">

    <!-- Leaderboard -->
    <div class="card p-4">
      <h3 class="font-semibold text-lg mb-2">Leaderboard (Weekly)</h3>
      <div id="leaderboardList" class="space-y-2 max-h-64 overflow-y-auto"></div>
    </div>

    <!-- Admin Panel -->
    <div class="card p-4 space-y-4" id="adminPanel" style="display:none;">
      <h3 class="font-semibold text-lg">Admin Panel</h3>
      <input id="userSearch" type="text" placeholder="Search users..." class="w-full border rounded px-2 py-1">
      <div id="usersList" class="space-y-2 max-h-64 overflow-y-auto"></div>
    </div>

  </aside>

</main>

<footer class="bg-gray-800 text-white p-4 text-center">© 2025 Coding Club</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, doc, onSnapshot, updateDoc, arrayUnion, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAn5x2mrHMe9tVAEGDL7XbQoL6RG-xbUfw",
  authDomain: "codingclub-website.firebaseapp.com",
  projectId: "codingclub-website",
  storageBucket: "codingclub-website.appspot.com",
  messagingSenderId: "349607815709",
  appId: "1:349607815709:web:edbdfe68f217fba585f4f4"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// DOM Elements
const logoutBtn = document.getElementById('logoutBtn');
const profileInitials = document.getElementById('profileInitials');
const profileUpload = document.getElementById('profileUpload');
const fullnameEl = document.getElementById('fullname');
const emailEl = document.getElementById('email');
const collegeEl = document.getElementById('college');
const memberSinceEl = document.getElementById('memberSince');
const weeklyChartCtx = document.getElementById('weeklyChart').getContext('2d');
const leaderboardList = document.getElementById('leaderboardList');
const coursesList = document.getElementById('coursesList');
const newCourseName = document.getElementById('newCourseName');
const addCourseBtn = document.getElementById('addCourseBtn');
const achievementsList = document.getElementById('achievementsList');
const newAchievement = document.getElementById('newAchievement');
const addAchievementBtn = document.getElementById('addAchievementBtn');
const certsList = document.getElementById('certsList');
const newCert = document.getElementById('newCert');
const addCertBtn = document.getElementById('addCertBtn');
const overallProgressEl = document.getElementById('overallProgress');
const overallProgressText = document.getElementById('overallProgressText');
const avgTestScoreEl = document.getElementById('avgTestScore');
const recentTasksEl = document.getElementById('recentTasks');
const testResultsEl = document.getElementById('testResults');
const adminPanel = document.getElementById('adminPanel');

let currentUserUid = null;
let currentUserRole = 'user';
let weeklyChart = null;

// Helper
const getInitials = name => name ? name.split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase() : 'U';

// Logout
logoutBtn.onclick = () => signOut(auth).then(()=>window.location.href='login.html');

// Auth state
onAuthStateChanged(auth, user=>{
  if(!user) return window.location.href='login.html';
  currentUserUid = user.uid;
  const userDocRef = doc(db,'users',currentUserUid);

  // Real-time user data
  onSnapshot(userDocRef, snapshot=>{
    const data = snapshot.data();
    if(!data) return;

    fullnameEl.textContent = data.fullname || '—';
    emailEl.textContent = data.email || '—';
    collegeEl.textContent = data.college || '—';
    memberSinceEl.textContent = `Member since: ${data.createdAt ? new Date(data.createdAt.seconds*1000).toLocaleDateString() : '—'}`;
    profileInitials.textContent = getInitials(data.fullname);
    currentUserRole = data.role || 'user';
    if(currentUserRole==='admin') adminPanel.style.display='block';

    renderWeeklyChart(data.weeklyScores || {});
    renderCourses(data.courses || []);
    renderAchievements(data.achievements || []);
    renderCerts(data.certifications || []);
    renderTasksAndTests(data);
  });

  // Real-time leaderboard
  const usersCol = collection(db,'users');
  onSnapshot(query(usersCol, orderBy('createdAt','desc')), snapshot=>{
    leaderboardList.innerHTML = '';
    snapshot.forEach((docSnap,i)=>{
      const u = docSnap.data();
      const score = u.weeklyScores ? Object.values(u.weeklyScores).reduce((a,b)=>a+b,0) : 0;
      const div = document.createElement('div');
      div.className='flex justify-between p-2 bg-gray-100 rounded';
      div.innerHTML = `<span>${i+1}. ${u.fullname||'—'}</span><span>${score}</span>`;
      leaderboardList.appendChild(div);
    });
  });
});

// Profile Upload
profileInitials.onclick = ()=> profileUpload.click();
profileUpload.onchange = async e => {
  const file = e.target.files[0]; if(!file) return;
  const storageRef = ref(storage, `profilePics/${currentUserUid}`);
  const uploadTask = uploadBytesResumable(storageRef, file);
  uploadTask.on('state_changed', null, null, async ()=>{
    const url = await getDownloadURL(uploadTask.snapshot.ref);
    await updateDoc(doc(db,'users',currentUserUid), { profilePicURL:url });
    profileInitials.style.backgroundImage = `url(${url})`;
    profileInitials.textContent = '';
  });
};

// Render Helpers
function renderWeeklyChart(weeklyScores){
  const today = new Date();
  const labels = [], dataArr = [];
  for(let i=6;i>=0;i--){
    const d = new Date(); d.setDate(today.getDate()-i);
    const key = d.toISOString().split('T')[0];
    labels.push(key.slice(5));
    dataArr.push(weeklyScores[key]||0);
  }
  if(weeklyChart){
    weeklyChart.data.labels = labels;
    weeklyChart.data.datasets[0].data = dataArr;
    weeklyChart.update();
    return;
  }
  weeklyChart = new Chart(weeklyChartCtx,{
    type:'bar',
    data:{labels,datasets:[{label:'Score',data:dataArr,backgroundColor:'#34D399'}]},
    options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
  });
}

function renderCourses(courses){
  coursesList.innerHTML='';
  courses.forEach(c=>{
    const div=document.createElement('div'); div.className='flex justify-between p-2 bg-gray-100 rounded'; div.textContent=c;
    coursesList.appendChild(div);
  });
}
addCourseBtn.onclick=async ()=>{
  const name=newCourseName.value.trim(); if(!name) return;
  await updateDoc(doc(db,'users',currentUserUid),{courses:arrayUnion(name)});
  newCourseName.value='';
};

function renderAchievements(achievements){
  achievementsList.innerHTML='';
  achievements.forEach(a=>{
    const div=document.createElement('div'); div.className='p-2 bg-gray-100 rounded'; div.textContent=a;
    achievementsList.appendChild(div);
  });
}
addAchievementBtn.onclick=async ()=>{
  const text=newAchievement.value.trim(); if(!text) return;
  await updateDoc(doc(db,'users',currentUserUid),{achievements:arrayUnion(text)});
  newAchievement.value='';
};

function renderCerts(certs){
  certsList.innerHTML='';
  certs.forEach(c=>{
    const div=document.createElement('div'); div.className='p-2 bg-gray-100 rounded'; div.textContent=c;
    certsList.appendChild(div);
  });
}
addCertBtn.onclick=async ()=>{
  const text=newCert.value.trim(); if(!text) return;
  await updateDoc(doc(db,'users',currentUserUid),{certifications:arrayUnion(text)});
  newCert.value='';
};

// Tasks & Tests
function renderTasksAndTests(data){
  // Overall Progress
  const totalTasks = data.tasks ? data.tasks.length :0;
  const completedTasks = data.tasks ? data.tasks.filter(t=>t.status==='completed').length :0;
  const percent = totalTasks ? Math.round((completedTasks/totalTasks)*100) :0;
  overallProgressEl.style.width = percent+'%';
  overallProgressText.textContent = percent+'%';

  // Average Score
  if(data.tests && data.tests.length){
    const totalScore = data.tests.reduce((a,b)=>a+b.score,0);
    const totalMax = data.tests.reduce((a,b)=>a+b.total,0);
    avgTestScoreEl.textContent = Math.round((totalScore/totalMax)*100);
  }else avgTestScoreEl.textContent=0;

  // Recent Tasks
  recentTasksEl.innerHTML='';
  if(data.tasks){
    data.tasks.slice(-5).reverse().forEach(t=>{
      const div=document.createElement('div');
      div.className='task-item '+(t.status==='completed'?'bg-green-100':'bg-yellow-100');
      div.innerHTML=`<span>${t.name}</span><span>${t.status}</span>`;
      recentTasksEl.appendChild(div);
    });
  }

  // Test Results
  testResultsEl.innerHTML='';
  if(data.tests){
    data.tests.forEach(test=>{
      const div=document.createElement('div'); div.className='test-item';
      div.innerHTML=`<strong>${test.name}</strong> - ${test.score}/${test.total}`;
      testResultsEl.appendChild(div);
    });
  }
}
</script>

</body>
</html>
