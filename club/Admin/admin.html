
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - Coding Club</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
:root{
  --accent:#1abc9c;
  --bg:#f4f6f9;
  --card:#fff;
  --muted:#7f8c8d;
  --danger:#e74c3c;
  --primary:#3498db;
}
body{margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:#2d3e50;}
header{background:var(--accent);padding:1rem;color:#fff;display:flex;justify-content:space-between;align-items:center;}
header button{background:transparent;color:#fff;border:1px solid #fff;padding:.3rem .7rem;border-radius:6px;cursor:pointer;}
main{max-width:1200px;margin:1rem auto;padding:1rem;}
.card{background:var(--card);padding:1rem;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.04);margin-bottom:1rem;}
.section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem;}
.list{display:flex;flex-direction:column;gap:.6rem;margin-top:.8rem;}
.list-item{display:flex;justify-content:space-between;align-items:center;padding:.6rem;background:#fbfdfe;border-radius:8px;border:1px solid #eef4f5;flex-wrap:wrap;}
.inline-btn{background:transparent;border:none;color:var(--muted);cursor:pointer;font-weight:600;}
.inline-btn.danger{color:var(--danger);}
.editable-input{border:none;border-bottom:1px dashed #ccc;padding:4px 6px;border-radius:4px;background:transparent;width:120px;}
.editable-input:focus{outline:none;border-bottom:1px solid var(--accent);}
table{width:100%;border-collapse:collapse;}
th,td{padding:.6rem;border-bottom:1px solid #eee;text-align:left;}
button{padding:.3rem .7rem;border-radius:6px;border:none;cursor:pointer;font-weight:600;}
button.primary{background:var(--accent);color:#fff;}
button.secondary{background:var(--primary);color:#fff;}
button.danger{background:var(--danger);color:#fff;}
@media(max-width:980px){.list-item{flex-direction:column;align-items:flex-start;}}
#loginCard{max-width:400px;margin:5% auto;}
#loginCard input{width:100%;padding:.6rem;margin:.5rem 0;border-radius:6px;border:1px solid #ccc;}
#loginCard button{width:100%;}
.progress-bar{height:10px;background:#ecf0f1;border-radius:5px;overflow:hidden;margin-top:4px;}
.progress-fill{height:100%;background:var(--accent);width:0%;transition:width .3s;}
.profile-initial{width:50px;height:50px;background:#3498db;color:#fff;font-weight:700;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;}
</style>
</head>
<body>

<header>
  Admin Panel
  <button id="logoutBtn"><i class="fa fa-sign-out-alt"></i> Logout</button>
</header>

<main>
  <!-- Admin Login -->
  <div id="loginCard" class="card">
    <h2>Admin Login</h2>
    <input type="email" id="adminEmail" placeholder="Email" />
    <input type="password" id="adminPass" placeholder="Password" />
    <button id="loginBtn" class="primary">Login</button>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" style="display:none;">
    <div class="card">
      <div class="section-title"><h3>Live Leaderboard (Weekly)</h3></div>
      <div class="list" id="leaderboardList"></div>
    </div>

    <div class="card">
      <div class="section-title"><h3>Manage Users</h3></div>
      <div class="list" id="usersList"></div>
    </div>
  </div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, collection, query, orderBy, onSnapshot, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAn5x2mrHMe9tVAEGDL7XbQoL6RG-xbUfw",
  authDomain: "codingclub-website.firebaseapp.com",
  projectId: "codingclub-website",
  storageBucket: "codingclub-website.firebasestorage.app",
  messagingSenderId: "349607815709",
  appId: "1:349607815709:web:edbdfe68f217fba585f4f4",
  measurementId: "G-5NDXD3NWK2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// DOM
const loginCard = document.getElementById('loginCard');
const dashboard = document.getElementById('dashboard');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const adminEmail = document.getElementById('adminEmail');
const adminPass = document.getElementById('adminPass');
const leaderboardList = document.getElementById('leaderboardList');
const usersList = document.getElementById('usersList');

// Admin login
loginBtn.addEventListener('click', async ()=>{
  try{
    const cred = await signInWithEmailAndPassword(auth, adminEmail.value, adminPass.value);
    const userRef = doc(db,'users',cred.user.uid);
    const snap = await userRef.get();
    const data = snap.data();
    if(data.role!=='admin') throw new Error('Not an admin!');
  }catch(err){ alert(err.message); }
});

// Logout
logoutBtn.addEventListener('click',()=>signOut(auth));

// Dashboard init
onAuthStateChanged(auth, async user=>{
  if(user){
    const userRef = doc(db,'users',user.uid);
    const snap = await userRef.get();
    const data = snap.data();
    if(data.role==='admin'){
      loginCard.style.display='none';
      dashboard.style.display='block';
      initLeaderboard();
      initUsers();
    }else{
      loginCard.style.display='block';
      dashboard.style.display='none';
    }
  }else{
    loginCard.style.display='block';
    dashboard.style.display='none';
  }
});

// Leaderboard
function initLeaderboard(){
  const q = query(collection(db,'users'), orderBy('weeklyTotal','desc'));
  onSnapshot(q, snap=>{
    leaderboardList.innerHTML='';
    snap.forEach(d=>{
      const data=d.data();
      const item = document.createElement('div'); item.className='list-item';
      const profileHTML = data.profilePicURL 
        ? `<img src="${data.profilePicURL}" style="width:40px;height:40px;border-radius:50%;margin-right:8px;">` 
        : `<div class="profile-initial">${data.fullname?data.fullname.split(' ').map(n=>n[0]).join(''):'--'}</div>`;
      item.innerHTML=`<div style="display:flex;align-items:center">${profileHTML}<strong>${data.fullname||'â€”'}</strong></div><div>${data.weeklyTotal||0} pts</div>`;
      leaderboardList.appendChild(item);
    });
  });
}

// Users
function initUsers(){
  const q = query(collection(db,'users'), orderBy('fullname'));
  onSnapshot(q, snap=>{
    usersList.innerHTML='';
    snap.forEach(d=>{
      const data=d.data();
      const uid = d.id;
      const item = document.createElement('div'); item.className='list-item';
      item.innerHTML=`
        <div style="display:flex;align-items:center;gap:8px;">
          ${data.profilePicURL?`<img src="${data.profilePicURL}" style="width:40px;height:40px;border-radius:50%;">`:`<div class="profile-initial">${data.fullname?data.fullname.split(' ').map(n=>n[0]).join(''):'--'}</div>`}
          <input class="editable-input" value="${data.fullname||''}" data-field="fullname" data-uid="${uid}" />
          <input class="editable-input" value="${data.college||''}" data-field="college" data-uid="${uid}" />
          <input class="editable-input" value="${data.year||''}" data-field="year" data-uid="${uid}" />
          <input type="file" class="profile-upload" data-uid="${uid}" accept="image/png,image/jpeg"/>
        </div>
        <div>
          <button class="inline-btn" data-uid="${uid}" data-action="promote">Promote</button>
          <button class="inline-btn" data-uid="${uid}" data-action="demote">Demote</button>
          <button class="inline-btn danger" data-uid="${uid}" data-action="delete">Delete</button>
        </div>
      `;
      usersList.appendChild(item);
    });

    document.querySelectorAll('.editable-input').forEach(input=>{
      input.addEventListener('change', async e=>{
        const field = e.target.dataset.field;
        const uid = e.target.dataset.uid;
        const value = e.target.value;
        await updateDoc(doc(db,'users',uid), {[field]:value});
      });
    });

    document.querySelectorAll('.inline-btn').forEach(btn=>{
      btn.addEventListener('click', async e=>{
        const uid = e.target.dataset.uid;
        const action = e.target.dataset.action;
        if(action==='delete'){ await deleteDoc(doc(db,'users',uid)); }
        else if(action==='promote'){ await updateDoc(doc(db,'users',uid), {role:'admin'}); }
        else if(action==='demote'){ await updateDoc(doc(db,'users',uid), {role:'user'}); }
      });
    });

    document.querySelectorAll('.profile-upload').forEach(input=>{
      input.addEventListener('change', async e=>{
        const file = e.target.files[0];
        if(!file) return;
        const uid = e.target.dataset.uid;
        const storageRef = ref(storage, `profilePics/${uid}`);
        const uploadTask = uploadBytesResumable(storageRef, file);
        uploadTask.on('state_changed', null, null, async ()=>{
          const url = await getDownloadURL(uploadTask.snapshot.ref);
          await updateDoc(doc(db,'users',uid), {profilePicURL:url});
        });
      });
    });
  });
}
</script>


</body>
</html>
